{"version":3,"file":"logger.js","names":["morgan","require","logger","requestFormat","tokens","req","res","requestId","id","user","Date","toISOString","method","url","status","referrer","join","next","randomBytes","toString","requestLogger","skip","paths","some","path","originalUrl","startsWith","stream","write","message","info","trim","errorLogger","err","error","timestamp","userId","statusCode","name","stack","process","env","NODE_ENV","undefined","body","query","params","headers","get","referer","slowRequestLogger","threshold","start","now","on","duration","warn","module","exports"],"sources":["../../src/middleware/logger.js"],"sourcesContent":["const morgan = require('morgan');\nconst logger = require('../config/logger');\n\n// Format personnalisé pour les logs de requêtes\nconst requestFormat = (tokens, req, res) => {\n  const requestId = req.id || 'unknown';\n  const user = req.user ? req.user.id : 'anonymous';\n  \n  return [\n    `[${new Date().toISOString()}]`,\n    `id:${requestId}`,\n    `user:${user}`,\n    `${tokens.method(req, res)}`,\n    `${tokens.url(req, res)}`,\n    `${tokens.status(req, res)}`,\n    `${tokens.res(req, res, 'content-length') || '-'}b`,\n    `${tokens['response-time'](req, res)}ms`,\n    `\"${tokens['user-agent'](req, res) || ''}\"`,\n    `\"${tokens.referrer(req, res) || ''}\"`,\n  ].join(' ');\n};\n\n// Middleware pour ajouter un ID unique à chaque requête\nconst requestId = (req, res, next) => {\n  req.id = require('crypto').randomBytes(8).toString('hex');\n  next();\n};\n\n// Configuration de Morgan pour la journalisation des requêtes\nconst requestLogger = () => {\n  // Filtre les requêtes de santé et de métriques\n  const skip = (req) => {\n    const paths = ['/health', '/metrics', '/favicon.ico'];\n    return paths.some(path => req.originalUrl.startsWith(path));\n  };\n  \n  return morgan(requestFormat, {\n    stream: {\n      write: (message) => logger.info(message.trim()),\n    },\n    skip,\n  });\n};\n\n// Middleware pour journaliser les erreurs\nconst errorLogger = (err, req, res, next) => {\n  const requestId = req.id || 'unknown';\n  const user = req.user ? req.user.id : 'anonymous';\n  \n  logger.error({\n    timestamp: new Date().toISOString(),\n    requestId,\n    userId: user,\n    method: req.method,\n    url: req.originalUrl,\n    statusCode: err.statusCode || 500,\n    error: {\n      name: err.name,\n      message: err.message,\n      stack: process.env.NODE_ENV === 'development' ? err.stack : undefined,\n    },\n    body: req.body,\n    query: req.query,\n    params: req.params,\n    headers: {\n      'user-agent': req.get('user-agent'),\n      referer: req.get('referer'),\n    },\n  });\n  \n  next(err);\n};\n\n// Middleware pour journaliser les requêtes lentes\nconst slowRequestLogger = (threshold = 1000) => {\n  return (req, res, next) => {\n    const start = Date.now();\n    \n    res.on('finish', () => {\n      const duration = Date.now() - start;\n      \n      if (duration > threshold) {\n        const requestId = req.id || 'unknown';\n        const user = req.user ? req.user.id : 'anonymous';\n        \n        logger.warn({\n          message: 'Requête lente détectée',\n          duration: `${duration}ms`,\n          threshold: `${threshold}ms`,\n          requestId,\n          userId: user,\n          method: req.method,\n          url: req.originalUrl,\n          statusCode: res.statusCode,\n        });\n      }\n    });\n    \n    next();\n  };\n};\n\nmodule.exports = {\n  requestId,\n  requestLogger,\n  errorLogger,\n  slowRequestLogger,\n};\n"],"mappings":"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","ignoreList":[]}