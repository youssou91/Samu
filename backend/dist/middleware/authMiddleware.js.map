{"version":3,"file":"authMiddleware.js","names":["jwt","require","asyncHandler","Utilisateur","exports","protegerRoute","req","res","next","token","headers","authorization","startsWith","split","decode","verify","process","env","JWT_SECRET","user","findOne","_id","id","actif","select","error","Error","statusCode","erreurs","champ","message","console","name","status","json","succes","autoriser","roles","includes","role","proprietaireOuAdmin","modele","champId","document","findById","params","modelName","estProprietaire","toString","estAdmin","erreur","NODE_ENV","undefined"],"sources":["../../src/middleware/authMiddleware.js"],"sourcesContent":["const jwt = require('jsonwebtoken');\nconst asyncHandler = require('express-async-handler');\nconst Utilisateur = require('../models/Utilisateur');\n\n// Middleware pour protéger les routes\nexports.protegerRoute = asyncHandler(async (req, res, next) => {\n  let token;\n\n  // Vérifier si le token est présent dans les en-têtes\n  if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {\n    try {\n      // Extraire le token du header\n      token = req.headers.authorization.split(' ')[1];\n\n      // Vérifier le token\n      const decode = jwt.verify(token, process.env.JWT_SECRET);\n\n      // Récupérer l'utilisateur à partir du token et vérifier s'il est actif\n      req.user = await Utilisateur.findOne({ \n        _id: decode.id, \n        actif: true \n      }).select('-motDePasse -__v -dateCreation -dateMiseAJour');\n      \n      if (!req.user) {\n        const error = new Error('Utilisateur non trouvé ou compte désactivé');\n        error.statusCode = 401;\n        error.erreurs = [\n          { champ: 'authentification', message: 'Votre compte a été désactivé ou n\\'existe plus' }\n        ];\n        throw error;\n      }\n      \n      next();\n    } catch (error) {\n      console.error('Erreur d\\'authentification:', error);\n      \n      let message = 'Session expirée ou invalide';\n      let statusCode = 401;\n      \n      if (error.name === 'JsonWebTokenError') {\n        message = 'Token invalide';\n      } else if (error.name === 'TokenExpiredError') {\n        message = 'Session expirée, veuillez vous reconnecter';\n      }\n      \n      res.status(statusCode).json({\n        succes: false,\n        message,\n        erreurs: [\n          { champ: 'authentification', message }\n        ]\n      });\n    }\n  } else {\n    res.status(401).json({ \n      succes: false,\n      message: 'Accès non autorisé',\n      erreurs: [\n        { champ: 'authentification', message: 'Aucun token d\\'authentification fourni' }\n      ]\n    });\n  }\n});\n\n// Middleware pour vérifier les rôles\nexports.autoriser = (...roles) => {\n  return (req, res, next) => {\n    if (!req.user) {\n      return res.status(401).json({\n        succes: false,\n        message: 'Non authentifié',\n        erreurs: [\n          { champ: 'autorisation', message: 'Vous devez être connecté pour accéder à cette ressource' }\n        ]\n      });\n    }\n\n    if (!roles.includes(req.user.role)) {\n      return res.status(403).json({\n        succes: false,\n        message: 'Accès refusé',\n        erreurs: [\n          { \n            champ: 'autorisation', \n            message: `Votre rôle (${req.user.role}) ne vous permet pas d'accéder à cette ressource`\n          }\n        ]\n      });\n    }\n    \n    next();\n  };\n};\n\n// Middleware pour vérifier la propriété ou les droits d'administration\nexports.proprietaireOuAdmin = (modele, champId = 'utilisateur') => {\n  return async (req, res, next) => {\n    try {\n      // Vérifier si l'utilisateur est authentifié\n      if (!req.user) {\n        return res.status(401).json({\n          succes: false,\n          message: 'Non authentifié',\n          erreurs: [\n            { champ: 'authentification', message: 'Vous devez être connecté pour effectuer cette action' }\n          ]\n        });\n      }\n\n      // Récupérer le document\n      const document = await modele.findById(req.params.id);\n      \n      if (!document) {\n        return res.status(404).json({\n          succes: false,\n          message: 'Ressource non trouvée',\n          erreurs: [\n            { champ: 'id', message: `${modele.modelName} non trouvé avec l'ID fourni` }\n          ]\n        });\n      }\n      \n      // Vérifier si l'utilisateur est le propriétaire ou un administrateur\n      const estProprietaire = document[champId] && document[champId].toString() === req.user.id;\n      const estAdmin = req.user.role === 'admin';\n      \n      if (!estProprietaire && !estAdmin) {\n        return res.status(403).json({\n          succes: false,\n          message: 'Accès refusé',\n          erreurs: [\n            { \n              champ: 'autorisation', \n              message: 'Vous n\\'êtes pas autorisé à effectuer cette action sur cette ressource' \n            }\n          ]\n        });\n      }\n      \n      // Stocker le document dans la requête pour une utilisation ultérieure\n      req.document = document;\n      next();\n    } catch (error) {\n      console.error(`Erreur lors de la vérification des droits sur ${modele.modelName}:`, error);\n      \n      let message = 'Une erreur est survenue lors de la vérification des droits';\n      let statusCode = 500;\n      \n      if (error.name === 'CastError') {\n        message = 'ID de ressource invalide';\n        statusCode = 400;\n      }\n      \n      res.status(statusCode).json({\n        succes: false,\n        message,\n        erreur: process.env.NODE_ENV === 'development' ? error.message : undefined\n      });\n    }\n  };\n};\n"],"mappings":"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","ignoreList":[]}